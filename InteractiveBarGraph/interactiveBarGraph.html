<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Interactive Bar Graph</title>
  <style>
    /* .bar {
      fill: green;
    } */

    .bar:hover {
      fill: blue;
    }

    .yAxis {
      font-size: 10px;
    }

    .categoryAxis {
      font-size: 10px;
    }

    svg {
      background-color: #cdcdcd;
      border: 3px solid blue;
    }

    /* svg rect {
      fill: red;
    } */
  </style>
</head>
<body>
  <p id="monthTitle">Expenses by Month</p>

  <script src="http://d3js.org/d3.v3.min.js"></script>
  <!-- <script src="interactiveBarGraph.js"></script> -->
  <script>
    // const data = [
    //   {exp: "Rent", cost: 10},
    //   {exp: "Apparel", cost: 25},
    //   {exp: "Utilities", cost: 15},
    //   {exp: "Groceries", cost: 40},
    //   {exp: "Subscriptions", cost: 25},
    //   {exp: "Travel", cost: 15},
    //   {exp: "Vehicle", cost: 30},
    //   {exp: "Other", cost: 35}
    // ];
    // const data = require("./month_expenses_2016.json");
    // const data = {{}};
    // console.log("Hello");
    //
    // d3.json("month_expenses_2016.json", data => {
    //   console.log(data);
    // });

    const data1 = [
      {
        "month1": {
          "_id":{"$oid":"5b1da795199fcd971f88e586"},
          "Expenses":[
          {"Expense":"mail","Cost":5.75,"Category":"Transport","Notes":"idk"},
          {"Expense":"chipotle","Cost":6.97,"Category":"Res","Notes":"burrito bowl"},
          {"Expense":"rent","Cost":800,"Category":"Rent","Notes":"clairmont reserve"},
          {"Expense":"noodles","Cost":9.42,"Category":"Res","Notes":"no"},
          {"Expense":"mcdonalds","Cost":6.84,"Category":"Res","Notes":null},
          {"Expense":"chips","Cost":4.87,"Category":"Snacks","Notes":null},
          {"Expense":"chick fil a","Cost":8.31,"Category":"Res","Notes":null},
          {"Expense":"mcdonalds","Cost":3.59,"Category":"Res","Notes":"case competition food"},
          {"Expense":"dunkin","Cost":4.41,"Category":"Res","Notes":null},
          {"Expense":"burger","Cost":6.68,"Category":"Res","Notes":"marlows (alpha)"},
          {"Expense":"mcdonalds","Cost":6.2,"Category":"Res","Notes":null},
          {"Expense":"transfer","Cost":40,"Category":"Credit Card","Notes":"payoff"},
          {"Expense":"shea butter","Cost":7.8,"Category":"Supplies","Notes":"for the hair"},
          {"Expense":"ross","Cost":7.48,"Category":"Clothes","Notes":"tie?"},
          {"Expense":"umbrella","Cost":5.32,"Category":"Rain","Notes":null},
          {"Expense":"fedEx","Cost":6.41,"Category":"Mail","Notes":"?"},
          {"Expense":"N4L dinner","Cost":16.05,"Category":"Res","Notes":"ethopian"},
          {"Expense":"racetrac?","Cost":5.73,"Category":"Other","Notes":"idk what this is"},
          {"Expense":"spotify","Cost":10.72,"Category":"Subscription","Notes":null},
          {"Expense":"cc interest","Cost":13.24,"Category":"Interest","Notes":null}
          ],
          "Month":"1"
        }
      }
    ]

    const data2 = [
      {
        "month2": {
        "_id":{"$oid":"5b1db58c199fcd97b0fd3bc7"},
        "Expenses":[
          {"Category":"Dry Cleaning","Notes":"kims","Cost":10.5,"Expense":"dry cleaning"},
          {"Category":"Interest","Notes":null,"Cost":12.59,"Expense":"interest charge"},
          {"Category":"Spotify","Notes":"music!","Cost":10.72,"Expense":"spotify"},
          {"Category":"Parking","Notes":"for 71","Cost":2,"Expense":"parking"},
          {"Category":"Res","Notes":null,"Cost":6.96,"Expense":"chick fil a"},
          {"Category":"Other","Notes":null,"Cost":5.01,"Expense":"pilot?"},
          {"Category":"Rent","Notes":"clairmont reserve","Cost":800,"Expense":"rent"},
          {"Category":"Res","Notes":"no","Cost":2.88,"Expense":"mcd"},
          {"Category":"Supplies","Notes":null,"Cost":32.39,"Expense":"sick stuff"},
          {"Category":"Clothes","Notes":null,"Cost":5.62,"Expense":"macys"},
          {"Category":"Res","Notes":"2.91","Cost":2.91,"Expense":"fast food"},
          {"Category":"Res","Notes":null,"Cost":4.48,"Expense":"mcd"},
          {"Category":"Res","Notes":"lot of food lol","Cost":6.96,"Expense":"chipotle"},
          {"Category":"Res","Notes":null,"Cost":4.21,"Expense":"chick fil a"},
          {"Category":"Tech","Notes":"still didn't help","Cost":43.15,"Expense":"laptop sleeve"},
          {"Category":"Res","Notes":null,"Cost":3.99,"Expense":"fast food again"},
          {"Category":"Res","Notes":"ole restaurant?","Cost":26.05,"Expense":"v-day food"},
          {"Category":"Res","Notes":null,"Cost":9.27,"Expense":"mcd"},
          {"Category":"Res","Notes":null,"Cost":5.41,"Expense":"subway"},
          {"Category":"Groceries","Notes":"publix","Cost":5.77,"Expense":"wings"},
          {"Category":"Res","Notes":"lots of it","Cost":9.9,"Expense":"mcd"},
          {"Category":"Credit Card","Notes":null,"Cost":50,"Expense":"cc payment"},
          {"Category":"Groceries","Notes":null,"Cost":7.42,"Expense":"publix"},
          {"Category":"Clothes","Notes":"down payment","Cost":20,"Expense":"recital tax pt 1"},
          {"Category":"Res","Notes":null,"Cost":3.83,"Expense":"suno"},
          {"Category":"Gas","Notes":"gas n food","Cost":22.58,"Expense":"gas money"},
          {"Category":"Other","Notes":"idk wtf this is","Cost":72.74,"Expense":"???"},
          {"Category":"Graduation","Notes":"pictures","Cost":117.18,"Expense":"grad pictures"},
          {"Category":"Alpha","Notes":"venmo to SC","Cost":150,"Expense":"chapter dues"},
          {"Category":"Res","Notes":null,"Cost":13.07,"Expense":"waffle house"},
          {"Category":"Atm","Notes":"at north decatur","Cost":20,"Expense":"atm"},
          {"Category":"Movies","Notes":"with abdella","Cost":21.39,"Expense":"deadpool"},
          {"Category":"Snacks","Notes":"at qt","Cost":2.66,"Expense":"vitamin water"}
        ],
        "Month":"2"}
      }
    ]

    // const dataset = data[0].month1;


    // d3.json("./month_expenses_2016.json", data => {
    //   const svgContainer = d3.select("body").append("svg")
    //   .attr("width", 1000)
    //   .attr("height", 550)
    //   // .append("g");
    //
    //   const marginSpace = 10;
    //
    //   // Rectangles using data
    //   const otherRectangles = svgContainer.selectAll(".bar")
    //   .data(data)
    //   .enter()
    //   .append("rect")
    //   .attr("class", "bar")
    //   .attr("x", (d, i) => (i * 60) + 130)
    //   .attr("y", d => 550 - marginSpace - (d.month1.Expenses[0].Cost * 10))
    //   // .attr("y", 400)
    //   .attr("width", 50)
    //   .attr("height", d => d.month1.Expenses[0].Cost * 10);
    //   // .attr("height", 100);
    // });

    // Category labels. Find a way to add directly from month expenses data
    const categoryLabels = {
      Rent: {
        labels: ["Rent"],
        goal: 800,
        color: [209, 145, 105]
      },
      Utilities: {
        labels: ["Util"],
        goal: 80,
        color: [165, 20, 165]
      },
      Phone: {
        labels: ["Phone"],
        goal: 65,
        color: [70, 150, 215]
      },
      Apparel: {
        labels: ["Clothes"],
        goal: 50,
        color: [195, 195, 30]
      },
      Supplies: {
        labels: ["Supplies", "Rain"],
        goal: 50,
        color: [42, 193, 243]
      },
      Technology: {
        labels: ["Tech"],
        goal: 40,
        color: [30, 240, 100]
      },
      Services: {
        labels: ["Dry Cleaning"],
        goal: 30,
        color: [141, 155, 20]
      },
      "Health/Gym": {
        labels: ["Health", "Gym"],
        goal: 50,
        color: [164, 72, 235]
      },
      Haircut: {
        labels: ["Haircut"],
        goal: 40,
        color: [99, 196, 126]
      },
      Groceries: {
        labels: ["Groceries"],
        goal: 200,
        color: [143, 15, 166]
      },
      "Other Food": {
        labels: ["Res", "Snacks"],
        goal: 300,
        color: [15, 242, 28]
      },
      "Gas & Parking": {
        labels: ["Gas", "Parking"],
        goal: 30,
        color: [34, 38, 141]
      },
      Insurance: {
        labels: ["Insurance"],
        goal: 40,
        color: [188, 159, 198]
      },
      "Bank & Credit Card": {
        labels: ["Credit Card", "Interest", "Atm"],
        goal: 40,
        color: [62, 141, 138]
      },
      "Student Loans": {
        labels: ["Student Loans"],
        goal: 400,
        color: [206, 117, 92]
      },
      "Vehicle Payments": {
        labels: ["Vehicle Payments"],
        goal: 20,
        color: [115, 73, 238]
      },
      "Entertainment": {
        labels: ["Movies"],
        goal: 30,
        color: [206, 18, 160]
      },
      "Subscriptions": {
        labels: ["Subscription", "Spotify"],
        goal: 25,
        color: [124, 232, 134]
      },
      Travel: {
        labels: ["Travel"],
        goal: 200,
        color: [118, 55, 65]
      },
      "Public Transportation": {
        labels: ["Uber", "Marta"],
        goal: 25,
        color: [252, 158, 155]
      },
      "Special/Seasonal": {
        labels: ["Graduation"],
        goal: null,
        color: [227, 250, 194]
      },
      Other: {
        labels: ["Other"],
        goal: null,
        color: [100, 100, 100]
      }
    }

    // Scales and Axis (eventually use band scale for y-axis)
    const width = 1100;
    const height = 500;
    const categoryLength = Object.keys(categoryLabels).length;
    const moveX = 40;
    const xDistance = (width - moveX)/categoryLength;
    const barWidth = 30;

    const heightScale = d3.scale.linear()
      .domain([0, 1000])
      .range([0, height]);

    const reverseHeightScale = d3.scale.linear()
      .domain([0, 1000])
      .range([height, 0]);

    const categoryScale = d3.scale.linear()
      .domain([0, width])
      .range([0, width]);

    const axis = d3.svg.axis()
      .ticks(20)
      .tickSize(5)
      .tickPadding(5)
      .scale(reverseHeightScale)
      .orient("left");

    const categoryAxis = d3.svg.axis()
      .ticks(categoryLength)
      .tickSize(2)
      .scale(categoryScale)
      .tickFormat((d, i) => {
        categoryNames = [];
        for (let prop in categoryLabels) {
          categoryNames.push(prop);
        }
        return categoryNames[i];
      })
      .orient("bottom");

    // set variable for smooth transition
    const t = d3.transition().duration(750);


    // Without d3.json import
    const svgContainer = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height+50)
    .append("g")
    .attr("transform", `translate(${moveX}, -10)`);
    // .call(axis);

    const marginSpace = 10;

    function processData(data, number) {
      let obj = data[0][`month${number}`].Expenses;
      let newDataSet = [];
      let totalValue = 0, totalExpenses = 0;

      for (let prop in categoryLabels) {
        let value = 0;
        for (let i = 0; i < obj.length; i++) {
          // Using only one property so that totalExpenses variable is done correctly
          if (prop === "Rent") {
            totalExpenses += obj[i].Cost;
          }
          if (categoryLabels[prop] !== "Other" && (categoryLabels[prop].labels.includes(obj[i].Category) || obj[i].Category === prop)) {
            value += obj[i].Cost;
            totalValue += obj[i].Cost;
          }
        }
        newDataSet.push({Expense: prop, Cost: value, Goal: categoryLabels[prop].goal, Color: categoryLabels[prop].color});
      }


      newDataSet[newDataSet.length-1] = {Expense: "Other", Cost: totalExpenses - totalValue, Goal: categoryLabels["Other"].goal, Color: categoryLabels["Other"].color};

      // console.log(newDataSet)
      return newDataSet;
    }

    // function to set colors for bars
    function colorBars(ht, goal, colors, i) {
      if (goal && ht > goal) {
        return 'rgb(200, 0, 0)';
      }
      let shade = (goal) ? ht/goal : 1;
      let red = colors[0], green = colors[1], blue = colors[2];
      return `rgb(${red*shade}, ${green*shade}, ${blue*shade})`;
    }


    // Set function to update with new data
    function update(data, number) {
      // Rectangles using data
      let otherRectangles = svgContainer.selectAll(".bar")
      .data(processData(data, number));

      // otherRectangles.exit().transition(t)
      // .attr("fill-opacity", 0.1)
      // .attr("height", 0)
      // .remove();

      // Updating old elements that are present in new data
      otherRectangles.transition(t)
      .attr("x", (d, i) => i * xDistance)
      // .attr("y", d => (d.Cost > 100) ? height - marginSpace - (d.Cost/2) : height - marginSpace - (d.Cost * 10))
      .attr("y", (d, i) => height - heightScale(d.Cost) + 1)
      // .attr("y", 400)
      .attr("width", barWidth)
      // .attr("height", d => (d.month1.Expensesst > 100) ? d.month1.Expensesst/2 : d.month1.Expensesst * 10);
      // .attr("height", 100)
      .attr("height", (d, i) => heightScale(d.Cost) + 1)
      .attr("fill", (d, i) => colorBars(d.Cost, d.Goal, d.Color, i));


      // Creating bars
      otherRectangles.enter()
      .append("rect")
      .attr("class", "bar")
      .attr("x", (d, i) => i * xDistance)
      // .attr("y", d => (d.month1.Expensesst > 100) ? height - marginSpace - (d.month1.Expensesst/2) : height - marginSpace - (d.month1.Expensesst * 10))
      .attr("y", (d, i) => height - heightScale(d.Cost) + 1)
      // .attr("y", 400)
      .attr("width", barWidth)
      // .attr("height", d => (d.month1.Expensesst > 100) ? d.month1.Expensesst/2 : d.month1.Expensesst * 10);
      // .attr("height", 100);
      .attr("height", 0)
      .attr("fill-opacity", 0.1)
      .transition(t)
      .attr("fill-opacity", 1)
      .attr("fill", (d, i) => colorBars(d.Cost, d.Goal, d.Color, i))
      // .attr("fill", "blue")
      // .attr("height", 100)
      .attr("height", (d, i) => heightScale(d.Cost) + 1);


      // Creating goal lines
      otherRectangles.enter()
      .append("line")
      .attr("class", "bar")
      .attr("x1", (d, i) => i * xDistance)
      .attr("y1", d => (d.Goal) ? height - heightScale(d.Goal) : null)
      // .attr("y1", 200)
      .attr("x2", (d, i) => (i * xDistance) + barWidth)
      .attr("y2", d => (d.Goal) ? height - heightScale(d.Goal) : null)
      // .attr("y2", 200)
      // .attr("stroke-width", 2)
      .attr("stroke-dasharray", 3.2)
      .attr("stroke", d => (d.Cost > d.Goal) ? "white" : "black")
      .attr("opacity", 0.4);

    }

    // Changing the data each second
    let flag = true, numeric = 1;
    setInterval(() => {
      dataset = flag ? data1 : data2;
      // dataset = data1;
      update(dataset, numeric);
      flag = !flag;
      numeric++;
      if (numeric > 2) {
        numeric = 1;
      }
    }, 1500);

    update(data1, 1);


    // Calling the axis
    svgContainer.append("g")
      .attr("class", "yAxis")
      .attr("transform", `translate(-10, 3)`)
      .call(axis);


    // Calling the categorical axis
    svgContainer.append("g")
      .attr("class", "categoryAxis")
      .attr("transform", `translate(-16, ${height+5})`)
      .call(categoryAxis)
      .selectAll("text")
      // .attr("transform", "translate(45, 0)")
      .attr("transform", "rotate(45)");

    // Name of current month
    // svgContainer.append("g")
    // .append("text")
    //   .attr("class", "title")
    //   .text("January Expenses")
    //   .attr("font-size", 32)
    //   .attr("color", "black");




  </script>
</body>
</html>
